(letrec ((call-loop (lambda (n f)
                      (if (= n 1)
                          (send f call (random 42))
                          (begin
                            (send f call (random 42))
                            (call-loop (- n 1) f)))))
         (factory-actor (actor "factory" (p)
                               (call (in)
                                     (send p update self in)
                                     (become factory-wait-actor p))))
         (factory-wait-actor (actor "factory-wait" (p)
                                    (done ()
                                          (become factory-actor p))
                                    (call (n)
                                          (send self call n)
                                          (become factory-wait-actor p))))
         (state-actor (actor "state" (n newstate)
                             (update (p in)
                                     (let ((m (newstate n in)))
                                       (send p done)
                                       (become state-actor m newstate)))))
         (state (create state-actor (random 42) (lambda (x y) (random 42))))
         (factory (create factory-actor state)))
  (call-loop (random 42) factory))
